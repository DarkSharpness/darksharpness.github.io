<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>dispatcher is all you need | DarkSharpness's Dungeon</title><meta name="author" content="DarkSharpness"><meta name="copyright" content="DarkSharpness"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="pytorch 写的是真的好. 本文会简单分析 torch 的 dispatcher, 以及实现在 C++ 侧实现自定义的 torch extension.">
<meta property="og:type" content="article">
<meta property="og:title" content="dispatcher is all you need">
<meta property="og:url" content="http://darksharpness.github.io/torch/index.html">
<meta property="og:site_name" content="DarkSharpness&#39;s Dungeon">
<meta property="og:description" content="pytorch 写的是真的好. 本文会简单分析 torch 的 dispatcher, 以及实现在 C++ 侧实现自定义的 torch extension.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2024/11/27/3e28dd3239526ce1.jpg">
<meta property="article:published_time" content="2024-11-26T18:08:43.000Z">
<meta property="article:modified_time" content="2025-01-26T07:20:05.024Z">
<meta property="article:author" content="DarkSharpness">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2024/11/27/3e28dd3239526ce1.jpg"><link rel="shortcut icon" href="https://s2.loli.net/2023/01/28/SnEi2v9sdczUuyG.png"><link rel="canonical" href="http://darksharpness.github.io/torch/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":1000,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'dispatcher is all you need',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/css/user.css"><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="DarkSharpness's Dungeon" type="application/atom+xml">
</head><body><div id="web_bg" style="background: black;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/01/28/SnEi2v9sdczUuyG.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-ellipsis-h"></i><span> 杂物</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-image"></i><span> 图床</span></a></li><li><a class="site-page child" href="/diary/"><i class="fa-fw fas fa-book"></i><span> 日记</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://s3.bmp.ovh/imgs/2024/11/27/3e28dd3239526ce1.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/01/28/SnEi2v9sdczUuyG.png" alt="Logo"><span class="site-name">DarkSharpness's Dungeon</span></a><a class="nav-page-title" href="/"><span class="site-name">dispatcher is all you need</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-ellipsis-h"></i><span> 杂物</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/photo/"><i class="fa-fw fas fa-image"></i><span> 图床</span></a></li><li><a class="site-page child" href="/diary/"><i class="fa-fw fas fa-book"></i><span> 日记</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">dispatcher is all you need</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-26T18:08:43.000Z" title="发表于 2024-11-27 02:08:43">2024-11-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-01-26T07:20:05.024Z" title="更新于 2025-01-26 15:20:05">2025-01-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C++</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/Framework/">Framework</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><!-- 咕咕咕, 等 OSDI 后再写. 如果你来 ping 我, 我会更快的更新. -->
<p><a target="_blank" rel="noopener" href="http://blog.ezyang.com/2020/09/lets-talk-about-the-pytorch-dispatcher/">参考文献</a>. 这篇很经典, 讲的比我好多了. 本文只是基于笔者的实践, 对于原文的选择性翻译. 本文全部图片来自那篇 blog.</p>
<p>具体的实验配置请参考 <a href="#环境配置">环境配置</a> 章节.</p>
<blockquote>
<p>小插曲: 由于原网站只支持 http, 而大部分浏览器默认的是禁止 mix http with https, 本网站又是强制 https 的, 所以图片链接全炸了. 笔者因此把那部分图片全部传到自己的图床了.</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在你使用 PyTorch 的时候, 你是否有想过, 对应的函数例如 <code>torch.add</code> 具体是如何操纵数据的? 更进一步, 在你调用 <code>with torch.no_grad()</code> 的时候, 究竟是什么机制使得所有的 kernel 都不会保留 gradient?</p>
<p>你可能会说: <code>if</code> ! 对的, 等效的来看, <code>torch</code> 的实现无非是借助一个一个的 <code>if</code>, 如果你的 tensor 在 GPU 上, 并且你的数据类型是 <code>float16</code>, 那么就会调用对应的 <code>cuda + float16 + add</code> 的 kernel.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> dtype == torch.float16 <span class="keyword">and</span> device.<span class="built_in">type</span> == <span class="string">&#x27;cuda&#x27;</span>:</span><br><span class="line">    <span class="keyword">return</span> cuda_float16_add</span><br></pre></td></tr></table></figure>
<p>但是, 考虑到 dtype 不是一成不变的 (学术界会提出越来越多的 quantization dtype 例如 <code>bfloat16</code>, <code>float8_e5m2</code>), 以及未来潜在的新的 device (比如 TPU, FPGA 等等). 在考虑可拓展性的情况下, 如果每种 kernel 都写成这种又臭又长的 <code>if</code> 条件判断的话, 那么后期的代码维护将会变得异常困难. 每多一个新的 dtype 或者 device, 开发者就需要把每个 kernel 都加上新的 <code>if</code>. 显然, 我们希望对于一个新的场景, 可以在不侵入修改原有代码的情况下实现.</p>
<p>这时候, 你可能会从你大一的程序设计课程中寻找灵感, 于是(笔者假设)你找到了一个类似的场景: 对于同一个函数, 表现出多态性, 可以使用虚函数 + 继承来实现. 这的确可以直接解决烦人的一堆 <code>if</code>, 但也有自己的局限性.</p>
<ol>
<li>虚函数一般是由虚表实现的, 而虚表是静态的, 无法在运行时注册用户的函数, 需要在编译期就全部确定, 用户拓展体验极差.</li>
<li>虚函数无法做到 bypass. 即对于同一个 tensor 的同一个函数 (比如前面的 <code>cuda + fp16 + add</code>), 在不同状态下 (比如 <code>with torch.no_grad()</code>), 选择不同的 kernel 去调用.</li>
</ol>
<p>为了更好的动态性和可维护性, 我们需要一套更加灵活的框架, 于是就有了 torch 的 Dispatcher.</p>
<h2 id="一些术语"><a href="#一些术语" class="headerlink" title="一些术语"></a>一些术语</h2><p><code>op</code>(operator): 算子, 表示对于数据的某种抽象操作, 比如 <code>add</code>.<br><code>kernel</code>: 算子的某种具体实现 (一般场景下可能指的是 cuda kernel, 但是本文放宽到所有类型的实现)<br><code>dtype</code>: torch 中表示数据类型的类, 常见的数据类型有 <code>int32</code>, <code>float32</code> 等等.<br><code>device</code>: torch 中表示数据所在的设备的类, 常见的设备有 <code>cuda</code>, <code>cpu</code> 等等.<br><code>layout</code>: torch 中表述数据存储形式的类, 常见的有 <code>strided</code>, <code>sparse_coo</code> 等等.<br><code>Tensor</code>: torch 的核心数据抽象, 可以理解为一块多维的矩阵, 可以认为是一个 <code>shared_ptr</code> + 内部实现.<br><code>IValue</code>(Interpreter Value): torch 的一种值类型, 类似 <code>std::any</code>, 可以存储常见值类型 (比如 <code>Tensor</code>, <code>int</code>).</p>
<h2 id="什么是-Dispatcher"><a href="#什么是-Dispatcher" class="headerlink" title="什么是 Dispatcher"></a>什么是 Dispatcher</h2><p>Dispatcher, 简单来说, 就是每个 op 具体应该调用哪个 kernel 的决定者. 决定调用哪个 op, 首先肯定要取决于输入 op 的 tensor 的本身的 dtype 和 device. 同时, 为了能够支持全局的某些开关 (比如 <code>torch.no_grad()</code>), 我们在 dispatch 的时候也需要考虑全局 global 的一些设定.</p>
<p>于是乎, 我们可以开始快乐的手搓动态虚表啦. 我们给每个可能的 key (op + device + dtype) 注册一个函数, 保留对应的函数指针. 但是, 事情并没有想象的那么简单.</p>
<h3 id="Boxing"><a href="#Boxing" class="headerlink" title="Boxing"></a>Boxing</h3><p>首先, 不同的 op 接受的参数是不一样的. <code>add</code> 需要输入两个 tensor 作为输入, 但是 <code>to</code> 就需要一个 tensor 加上对应的 dtype 或者 device. C++ 作为一种静态语言, 调用的 function 的函数签名必须是编译期确定并且匹配的, 但是每个 op 的函数签名是不尽相同的. 如果要中心化的用 dispatcher 来管理 dispatch, 那么 C++ 静态特性要求你的函数签名必须是完全相同的, 否则你就需要给每种函数签名单独维护一个 mapping, 这样的代码也会变得臃肿而难以维护.</p>
<p>因此在这里, 我们需要引入 boxing 的概念. boxing 指的是, 我们对于 torch 中的用到的类型, 比如 <code>tensor</code>, <code>int64</code>, <code>float32</code> 等等, 统一装到一个类型里面. 看到这里, 相信读者很自然的能联想到 <code>std::any</code>, <code>std::variant</code> 之类的东西. 这就是 torch 里面重要的值类型: <code>IValue</code>. 他把类型签名全部抹去, 把不同的类都尽可能装入了同一个 <code>IValue</code> 类里面, 从而部分解决了 C++ 静态类型的问题. 当然, 这样是不够的, 除了参数类型不同, 参数数量可能也是不一样的, 所以我们还需要手动维护一个 std::vector 类似的结构, 使得输入的参数类型可以是变长的即可. 以下即为一种简单的实现:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Possible combination of keys</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">KeyType</span> &#123;</span><br><span class="line">    std::string op_name;</span><br><span class="line">    Dtype data;</span><br><span class="line">    Device device;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Possible Implementation</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DispatchTable</span> &#123;</span><br><span class="line">    std::unordered_map&lt;KeyType, std::function&lt;std::any(std::vector&lt;std::any&gt;)&gt;&gt; table;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/1cc1d873b86666a1.png" alt="关于 box 的示意图">.</p>
<p>通过 boxing, 我们就可以很方便的中心化管理一个大 mapping, 其本质上是 C++ 中类型擦除的思想, 在 <code>std::any</code> 和 <code>std::variant</code> 中都有涉及.</p>
<h3 id="Dispatch-Logic"><a href="#Dispatch-Logic" class="headerlink" title="Dispatch Logic"></a>Dispatch Logic</h3><p>boxing 解决了接口一致性的问题, 使得中心化管理变得可能. 但这样一个框架, 他不一定方便. 假如 torch 真的采用了类似我们的伪代码的实现, 那么其很难支持动态的插入 <code>torch.no_grad()</code> 等涉及全局状态逻辑.</p>
<p>对于每一种涉及全局状态的逻辑, 如果把 global state 也直接暴力融入 dispatch key 之中, 那么就会遇到复杂度爆炸: 对于每一种可能的组合, 你都需要给予一种映射规则, 但是在考虑上全局状态后, 每一个额外的状态都会使得组合的可能乘以 2 (e.g. device + dtype + auto_grad + tracing……). 而全局状态到处都是: tracing, auto_grad, fake tensor 等等. 重新审视我们的全局状态, 很多时候我们其实不 care 两个 state 同时启用的时候是如何协同的, 在层层抽象之后, 不同模块之间应当已经良好的解耦了.</p>
<p>对于 tracing, auto_grad, fake_tensor 这些类似 hook 的功能, 我们其实只是希望能在调用真实的 kernel 前后先做点事情. 更近一步, 我们更希望的是他能像 python 的 decorator 一样, 由具体的实现来决定是否继续调用下面的 kernel:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dummy_hook_function</span>(<span class="params">f, args</span>):</span><br><span class="line">    <span class="comment"># in reality, you may do something before/after `f`</span></span><br><span class="line">    <span class="comment"># you may even avoid calling `f` under certain circumstance</span></span><br><span class="line">    <span class="keyword">return</span> f(args)</span><br><span class="line"><span class="comment"># original</span></span><br><span class="line">real_kernel(args);</span><br><span class="line"><span class="comment"># original + hook</span></span><br><span class="line">hook_function(real_kernel, args);</span><br></pre></td></tr></table></figure>
<p>因此, 我们实际要做的是, 对于某些全局状态, 如果启用了, 那么在 dispatch 的时候, 在调用真实 kernel 的前后插入一些执行逻辑.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Possible combination of keys</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">KeyType</span> &#123;</span><br><span class="line">    std::string op_name;</span><br><span class="line">    Dtype data;</span><br><span class="line">    Device device;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Possible Implementation</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DispatchTable</span> &#123;</span><br><span class="line">    <span class="keyword">using</span> Args_t = std::vector&lt;std::any&gt;;</span><br><span class="line">    <span class="keyword">using</span> F = std::function&lt;std::<span class="built_in">any</span>(Args_t)&gt;;</span><br><span class="line">    std::unordered_map&lt;KeyType, F&gt; table;</span><br><span class="line">    std::vector &lt;std::pair&lt;F, Args_t&gt;&gt; hooks;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>事实上, 复杂度爆炸一个很重要的原因就是, 存在协同操作的可能. 如果功能两两不相交, 那么 dispatch 的时候只需要调用最高优先级的那个 kernel 就可以了, 是否继续往下调用取决于最高优先级的 kernel, 这些适用于绝大部分的全局状态. 如果维护两两相交的状态, 假设一共有 $n$ 种状态, 那么复杂度一下子就从 $O(n)$ 上升到了 $O(n^2)$, 更别说所有的一起考虑, 那就是 $O(2^n)$ 了.</p>
<p>在实际的 torch dispatcher 的实现中, 是以 op 为中心维护的. 对于一个 op, 其维护了一个 key_set, 表示可能的 backend (即 device) 以及 functional key (即前面说的 Fake Tensor, Autocast 之类的). 而 DispatchKeySet 则是由两者拼接而成的, 本质上是一个 bitset.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Part of the code from PyTorch: include/c10/core/DispatchKey.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> C10_FORALL_BACKEND_COMPONENTS(_, extra) \</span></span><br><span class="line"><span class="meta">  _(CPU, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(CUDA, extra)                                \</span></span><br><span class="line"><span class="meta">  _(HIP, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(XLA, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(MPS, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(IPU, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(XPU, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(HPU, extra)                                 \</span></span><br><span class="line"><span class="meta">  _(VE, extra)                                  \</span></span><br><span class="line"><span class="meta">  _(Lazy, extra)                                \</span></span><br><span class="line"><span class="meta">  _(MTIA, extra)                                \</span></span><br><span class="line"><span class="meta">  _(PrivateUse1, extra)                         \</span></span><br><span class="line"><span class="meta">  _(PrivateUse2, extra)                         \</span></span><br><span class="line"><span class="meta">  _(PrivateUse3, extra)                         \</span></span><br><span class="line"><span class="meta">  _(Meta, extra)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">BackendComponent</span> : <span class="type">uint8_t</span> &#123;</span><br><span class="line">  InvalidBit = <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_BACKEND_COMPONENT(n, _) n##Bit,</span></span><br><span class="line">  <span class="built_in">C10_FORALL_BACKEND_COMPONENTS</span>(DEFINE_BACKEND_COMPONENT, unused)</span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> DEFINE_BACKEND_COMPONENT</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Define an alias to represent end of backend dispatch keys.</span></span><br><span class="line">  <span class="comment">// If you add new backend keys after PrivateUse3, please also update it here.</span></span><br><span class="line">  EndOfBackendKeys = MetaBit,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">DispatchKey</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ FIN ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ //</span></span><br><span class="line">  EndOfFunctionalityKeys, <span class="comment">// End of functionality keys.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">static_assert</span>(</span><br><span class="line">    (<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(BackendComponent::EndOfBackendKeys) +</span><br><span class="line">     <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(DispatchKey::EndOfFunctionalityKeys)) &lt;= <span class="number">64</span>,</span><br><span class="line">    <span class="string">&quot;The BackendComponent and DispatchKey enums (below EndOfFunctionalityKeys)&quot;</span></span><br><span class="line">    <span class="string">&quot; both map to backend and functionality bits&quot;</span></span><br><span class="line">    <span class="string">&quot; into a 64-bit bitmask; you must have less than 64 total entries between them&quot;</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Part of the code from PyTorch: include/c10/core/DispatchKeySet.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DispatchKeySet</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">constexpr</span> <span class="keyword">explicit</span> <span class="title">DispatchKeySet</span><span class="params">(BackendComponent k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (k == BackendComponent::InvalidBit) &#123;</span><br><span class="line">      repr_ = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      repr_ = <span class="number">1ULL</span> &lt;&lt; (<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(k) - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">constexpr</span> <span class="keyword">explicit</span> <span class="title">DispatchKeySet</span><span class="params">(DispatchKey k)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// NOLINTNEXTLINE(bugprone-branch-clone)</span></span><br><span class="line">    <span class="keyword">if</span> (k == DispatchKey::Undefined) &#123;</span><br><span class="line">      <span class="comment">// Case 1: handle Undefined specifically</span></span><br><span class="line">      repr_ = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (k &lt;= DispatchKey::EndOfFunctionalityKeys) &#123;</span><br><span class="line">      <span class="comment">// Case 2: handle &quot;functionality-only&quot; keys</span></span><br><span class="line">      <span class="comment">// These keys have a functionality bit set, but no backend bits</span></span><br><span class="line">      <span class="comment">// These can technically be either:</span></span><br><span class="line">      <span class="comment">// - valid runtime keys (e.g. DispatchKey::AutogradOther,</span></span><br><span class="line">      <span class="comment">// DispatchKey::FuncTorchBatched, etc)</span></span><br><span class="line">      <span class="comment">// - &quot;building block&quot; keys that aren&#x27;t actual runtime keys (e.g.</span></span><br><span class="line">      <span class="comment">// DispatchKey::Dense or Sparse)</span></span><br><span class="line">      <span class="type">uint64_t</span> functionality_val = <span class="number">1ULL</span></span><br><span class="line">          &lt;&lt; (num_backends + <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(k) - <span class="number">1</span>);</span><br><span class="line">      repr_ = functionality_val;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (k &lt;= DispatchKey::EndOfRuntimeBackendKeys) &#123;</span><br><span class="line">      <span class="comment">// Case 3: &quot;runtime&quot; keys that have a functionality bit AND a backend bit.</span></span><br><span class="line">      <span class="comment">// First compute which bit to flip for the functionality.</span></span><br><span class="line">      <span class="keyword">auto</span> functionality_k = <span class="built_in">toFunctionalityKey</span>(k);</span><br><span class="line">      <span class="comment">// The - 1 is because Undefined is technically a &quot;functionality&quot; that</span></span><br><span class="line">      <span class="comment">// doesn&#x27;t show up in the bitset. So e.g. Dense is technically the second</span></span><br><span class="line">      <span class="comment">// functionality, but the lowest functionality bit.</span></span><br><span class="line">      <span class="type">uint64_t</span> functionality_val = <span class="number">1ULL</span></span><br><span class="line">          &lt;&lt; (num_backends + <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(functionality_k) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// then compute which bit to flip for the backend</span></span><br><span class="line">      <span class="comment">// Case 4a: handle the runtime instances of &quot;per-backend functionality&quot;</span></span><br><span class="line">      <span class="comment">// keys For example, given DispatchKey::CPU, we should set:</span></span><br><span class="line">      <span class="comment">// - the Dense functionality bit</span></span><br><span class="line">      <span class="comment">// - the CPUBit backend bit</span></span><br><span class="line">      <span class="comment">// first compute which bit to flip for the backend</span></span><br><span class="line">      <span class="keyword">auto</span> backend_k = <span class="built_in">toBackendComponent</span>(k);</span><br><span class="line">      <span class="type">uint64_t</span> backend_val = backend_k == BackendComponent::InvalidBit</span><br><span class="line">          ? <span class="number">0</span></span><br><span class="line">          : <span class="number">1ULL</span> &lt;&lt; (<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(backend_k) - <span class="number">1</span>);</span><br><span class="line">      repr_ = functionality_val + backend_val;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// At this point, we should have covered every case except for alias keys.</span></span><br><span class="line">      <span class="comment">// Technically it would be possible to add alias dispatch keys to a</span></span><br><span class="line">      <span class="comment">// DispatchKeySet, but the semantics are a little confusing and this</span></span><br><span class="line">      <span class="comment">// currently isn&#x27;t needed anywhere.</span></span><br><span class="line">      repr_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="keyword">constexpr</span> <span class="title">DispatchKeySet</span><span class="params">(<span class="type">uint64_t</span> repr)</span> : repr_(repr) &#123;</span>&#125;</span><br><span class="line">  <span class="type">uint64_t</span> repr_ = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>当然, 在实践中, torch 还有很多的细节, 比如 DispatchKey enum 并不只有 functional key, 还有 backend + functional 的交叉 key 组合 (比如 SparseCUDA, QuantizedMPS). 在计算 DispatchKeySet 的时候, 对于组合的 key 会手动的拆成 bitset 中的两个 bit. 在实际决定按照哪个 dispatch key 优先的时候, 会把所有的 tensor input 含有的 key 汇集在一起, 加上全局的一些状态量, 最后先调用 DispatchKeySet 中的最高的那个 bit 对应的 kernel.</p>
<blockquote>
<p>Remark: 如果仔细看一眼 DispatchKeySet 的构造函数的逻辑, 你会发现 functionality 的 key 的优先级是高于 device 的 key 的. 这很合理, 功能性一般都是 override 在 function 之上的.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/6cdc40305760d4f9.png" alt="Which kernel shall i call?"></p>
<h2 id="实验部分"><a href="#实验部分" class="headerlink" title="实验部分"></a>实验部分</h2><p>说了这么多, 该写代码了. Talk is cheap, show me the code.</p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>笔者使用的是 <code>nvcc 12.4</code> + <code>PyTorch 2.5.1</code> + <code>gcc 13.2</code> + <code>clangd 19.1.2</code> 的组合. 关于 torch 的安装, 请参考 <a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/">官网</a>. 笔者选择的是 <code>2.5.1 + Linux + pip + cuda 12.4</code>. 环境管理笔者用的是 conda:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conda create -n torch python=3.10 -y</span><br><span class="line"><span class="comment"># 这一段请参考官网配置</span></span><br><span class="line">conda activate torch</span><br><span class="line">pip3 install torch torchvision torchaudio</span><br></pre></td></tr></table></figure>
<p>然后创建一个 <code>test.cu</code> 文件, 作为测试代码用的文件, 后面的改动都将放在这个文件中. 这里参考了 torch 官方给出的 <a target="_blank" rel="noopener" href="https://pytorch.org/tutorials/advanced/cpp_extension.html">custom C++ extension</a> 的部分.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;torch/extension.h&gt;</span></span></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(TORCH_EXTENSION_NAME, m) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了 setup 整个项目, 还需要一个 setup.py 文件, 随后只需要 <code>python setup.py install</code> 即可编译并安装 <code>my_test</code> 库.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"><span class="keyword">from</span> torch.utils <span class="keyword">import</span> cpp_extension</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">&#x27;my_test&#x27;</span>,</span><br><span class="line">      ext_modules=[cpp_extension.CppExtension(<span class="string">&#x27;my_test&#x27;</span>, [<span class="string">&#x27;test.cu&#x27;</span>],</span><br><span class="line">                                              extra_compile_args=[<span class="string">&#x27;-O3&#x27;</span>])],</span><br><span class="line">      cmdclass=&#123;<span class="string">&#x27;build_ext&#x27;</span>: cpp_extension.BuildExtension&#125;)</span><br></pre></td></tr></table></figure>
<p>当然, VSCode 默认 C/C++ 插件的代码补全显然是找不到需要的头文件的, 这会使得我们的编程变得极其痛苦. 笔者推荐使用 clangd 插件 + compile_commands.json.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;directory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/dark/workspace/torch&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;/usr/local/cuda/bin/nvcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-I/home/dark/miniconda3/envs/torch/lib/python3.10/site-packages/torch/include&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-I/home/dark/miniconda3/envs/torch/lib/python3.10/site-packages/torch/include/torch/csrc/api/include&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-I/home/dark/miniconda3/envs/torch/lib/python3.10/site-packages/torch/include/TH&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-I/home/dark/miniconda3/envs/torch/lib/python3.10/site-packages/torch/include/THC&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-I/home/dark/miniconda3/envs/torch/include/python3.10&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-c&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;test.cu&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-o&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;build/temp.linux-x86_64-cpython-310/test.o&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-D__CUDA_NO_HALF_OPERATORS__&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-D__CUDA_NO_HALF_CONVERSIONS__&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-D__CUDA_NO_BFLOAT16_CONVERSIONS__&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-D__CUDA_NO_HALF2_OPERATORS__&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-O3&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-DTORCH_API_INCLUDE_EXTENSION_H&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-DPYBIND11_COMPILER_TYPE=\&quot;_gcc\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-DPYBIND11_STDLIB=\&quot;_libstdcpp\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-DPYBIND11_BUILD_ABI=\&quot;_cxxabi1011\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-DTORCH_EXTENSION_NAME=my_test&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;-std=c++17&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test.cu&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>读者只需修改其中 miniconda, nvcc, 工作目录等路径即可. 当然, 这样可能不是非常具有可拓展性. 笔者获取 compile_commands.json 的方式是, 先直接运行一次 <code>python setup.py install</code>, 他会在命令行输出对应的编译指令. 读者可以复制其给出的编译指令, 然后用以下的 python 脚本拆分:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msg = <span class="string">&quot;&quot;</span> <span class="comment"># 这里换成你的编译命令</span></span><br><span class="line">seg = msg.split()</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="built_in">print</span>(json.dumps(seg, indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<p>至此, 你的 clangd 大概是能工作了, 读者也可以自行删除一些会让 clangd 无法识别的命令行参数.</p>
<h3 id="年轻人的第一个-pybind"><a href="#年轻人的第一个-pybind" class="headerlink" title="年轻人的第一个 pybind"></a>年轻人的第一个 pybind</h3><p>首先先写一个 Hello World 来熟悉一下 pybind 的流程, 这里暂时不涉及 torch 的内容. pybind 简单来说就是允许你从 python 一侧调用 C++ 的函数, 对于基本类型提供了自动转换的功能 (比如 C++ 的 bool 到 python 的 bool). 我们在 test.cu 中加入一个 <code>hello</code> 函数:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;torch/extension.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">hello</span><span class="params">(<span class="type">int</span> n)</span> -&gt; std::string </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello World! &quot;</span> &lt;&lt; n &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">to_string</span>(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(TORCH_EXTENSION_NAME, m) &#123;</span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;hello_world&quot;</span>, hello); <span class="comment">// Define hello_world function in python</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后, 使用 <code>python setup.py install</code> 来编译并安装. 在安装好后, 在 python 中运行以下的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch <span class="comment"># 这是一个小细节, 似乎必须先 import torch 再 import 自己的拓展</span></span><br><span class="line"><span class="keyword">import</span> my_test</span><br><span class="line"></span><br><span class="line">x = my_test.hello_world(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># print(x, type(x))</span></span><br></pre></td></tr></table></figure>
<p>你应该会得到意料之中的结果, 即输出了 <code>&quot;Hello World! 1&quot;</code>, 并且 x 是字符串 <code>&quot;1&quot;</code>.</p>
<h3 id="年轻人的第一个-torch-extension"><a href="#年轻人的第一个-torch-extension" class="headerlink" title="年轻人的第一个 torch extension"></a>年轻人的第一个 torch extension</h3><p>当然, 我们写 torch extension 大概率不只是为了用到 pybind 的功能, 我们可能还想要自己定义一些 op. 在 torch 中, 你可以自己注册一个 op, 也可以为已有的 op 按照一定规则绑定 key 和 kernel. 简单来说, 有三种注册模式:</p>
<ol>
<li>注册一个新的 op 并且绑定默认的 kernel</li>
<li>为某一个 key 绑定 kernel (fallback)</li>
<li>为某个 op + key 绑定 kernel</li>
</ol>
<p>这里引用一下原文的图来解释:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/d3a8536f4417a26d.png" alt="new op"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/36b6a8c526527abf.png" alt="functionality"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/4777ef735747bbe1.png" alt="op + functionality"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/01/26/059407e79872f76c.png" alt="summary &amp; priority"></p>
<p>下面, 我们用一些简单的代码来演示这些功能.</p>
<blockquote>
<p>Remark: 以下部分和原 blog 稍有出入, 毕竟那篇 blog 都是 5 年前的玩意了</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;torch/extension.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">hello</span><span class="params">(<span class="type">int</span> n)</span> -&gt; std::string </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello World! &quot;</span> &lt;&lt; n &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">to_string</span>(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">add_1_forward</span><span class="params">(at::Tensor x)</span> -&gt; at::Tensor </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> &amp;&amp;op  = c10::Dispatcher::<span class="built_in">singleton</span>().<span class="built_in">findSchemaOrThrow</span>(<span class="string">&quot;aten::add_1&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> stack = c10::Stack&#123;&#125;;</span><br><span class="line">    stack.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;at::TensorBase&gt;(x));</span><br><span class="line">    <span class="comment">// call boxed kernel</span></span><br><span class="line">    op.<span class="built_in">callBoxed</span>(&amp;stack);</span><br><span class="line">    <span class="keyword">return</span> stack[<span class="number">0</span>].<span class="built_in">toTensor</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">add_1_cpu</span><span class="params">(at::Tensor x)</span> -&gt; at::Tensor </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> kKeySet = c10::DispatchKeySet&#123;c10::DispatchKey::TESTING_ONLY_GenericMode&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">custom_hook</span><span class="params">(<span class="type">const</span> c10::OperatorHandle &amp;op, c10::Stack *stack)</span> -&gt; <span class="type">void</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> kGuard   = c10::impl::ExcludeDispatchKeyGuard&#123;kKeySet&#125;;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">auto</span> counter = std::<span class="type">size_t</span>&#123;&#125;;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Custom hook called &quot;</span> &lt;&lt; counter++ &lt;&lt; <span class="string">&quot; times&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> op.<span class="built_in">callBoxed</span>(stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">auto</span> <span class="title">enable_hook</span><span class="params">(<span class="type">bool</span> enable)</span> -&gt; <span class="type">void</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">auto</span> guard = std::optional&lt;c10::impl::IncludeDispatchKeyGuard&gt;&#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">        guard.<span class="built_in">emplace</span>(kKeySet);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        guard.<span class="built_in">reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>(TORCH_EXTENSION_NAME, m) &#123;</span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;hello_world&quot;</span>, hello); <span class="comment">// Define hello_world function in python</span></span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;add_1&quot;</span>, add_1_forward);</span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;enable_hook&quot;</span>, enable_hook);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TORCH_LIBRARY_FRAGMENT</span>(aten, m) &#123;</span><br><span class="line">    <span class="comment">// register add_1 function for aten namespace</span></span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;add_1&quot;</span>, [](at::Tensor) -&gt; at::Tensor &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Debug: Not implemented yet!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TORCH_LIBRARY_IMPL</span>(aten, CPU, m) &#123;</span><br><span class="line">    <span class="comment">// register add_1 function for aten namespace</span></span><br><span class="line">    m.<span class="built_in">impl</span>(<span class="string">&quot;add_1&quot;</span>, add_1_cpu);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">TORCH_LIBRARY_IMPL</span>(_, TESTING_ONLY_GenericMode, m) &#123;</span><br><span class="line">    m.<span class="built_in">fallback</span>(torch::CppFunction::<span class="built_in">makeFromBoxedFunction</span>&lt;custom_hook&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很长, 但是核心是最后三个以 TORCH_LIBRARY 开头的东西. 如果你希望在原有的 aten library 里面增加 op, 需要用到 <code>TORCH_LIBRARY_FRAGMENT</code> 这个宏,  <code>TORCH_LIBRARY</code> 代表的是一个新的 library, 这一点和原文略有不同. 在编译完上述代码之后, 可以用以下 python 代码进行测试:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> my_test</span><br><span class="line"></span><br><span class="line">x = torch.tensor([<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>])</span><br><span class="line"><span class="built_in">print</span>(my_test.add_1(x))</span><br><span class="line"></span><br><span class="line">my_test.enable_hook(<span class="literal">True</span>)</span><br><span class="line">y = my_test.add_1(x)</span><br><span class="line">y = y + <span class="number">1</span></span><br><span class="line">my_test.enable_hook(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(y)</span><br></pre></td></tr></table></figure>
<p>理论上, 你应该看到以下的输出:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tensor([2., 3., 4.])</span><br><span class="line">Custom hook called 0 times</span><br><span class="line">  Operator: aten::add_1</span><br><span class="line">Custom hook called 1 times</span><br><span class="line">  Operator: aten::add</span><br><span class="line">tensor([3., 4., 5.])</span><br></pre></td></tr></table></figure>
<p>这里鼓励读者多做一些尝试. 比如尝试 <code>x = x.to(&#39;cuda&#39;)</code>, 看看这时候再调用 <code>my_test.add_1(x)</code> 有何效果. 同时, 读者也可以尝试去除 <code>custom_hook</code> 中的 <code>kGuard</code>, 这个 guard 的作用是在构造的时候临时 disable 指定的 DispatchKeySet, 并且在析构的时候恢复原样 (类似 <code>std::lock_guard</code> 的原理), 看看结果是否和你想的一样. 或者, 读者也可以自行修改 <code>custom_hook</code>, 比如尝试不调用 <code>callBoxed</code> 等等. 同时, 观察一下 <code>custom_hook</code>, 相信读者也能意识到 boxing 的重要性: 如果没有 boxing, 根本无法为不同函数签名的各种 op 注册一个统一的 fallback.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>没啥好总结的, PyTorch 为解决 kernel 分发问题提出的 Dispatcher 抽象是非常成功的. 其解决了多种功能 key 组合带来的复杂度爆炸的问题, 把 backend 和 functionality 作为 DispatchKeySet 的一部分, Dispatcher 每次调用最高优先级的 key 对应的 kernel, 由被调用的 kernel 决定是否继续 redispatch 调用其他 kernel, 并且提出了 boxing 的抽象, 成功解决了虚函数的静态性的问题, 实现了一套统一的 dispatch 的机制, 避免了满天飞的 <code>if</code> 特判.</p>
<p>这一套框架乍一看很自然, 但是在你自己写的是很难想到如此多的细节的, 很容易写着写着就多出来一堆 <code>if</code>, 最后代码逻辑复杂到自己都看不懂. 不仅如此, PyTorch 还做了大量工程上的优化, 提供了许多工程上的便利, 这部分非常考验 C++ 的功底. 比如 DispatchKeySet 实际上就是压位压到了 64-bit 以内, 从而可以用一个整数直接表示, 这样避免了用动态 bitset 甚至是 vector 之类的结构, 减少了内存占用. 同时, 通过 <code>DispatchKeyGuard</code> 可以很方便的临时 <code>enable/disable</code> 某些全局 key, 这类 RAII 的思想也使得代码变得非常清晰易读 (这里点名批评 C 的 goto 作为 cleanup). 而 boxing 的核心 <code>IValue</code> 本身也用到了 <code>sso</code> 的思路 (可以参考 <a href="/cpp/#small-size-optimization"> 这一部分 </a>), 从而减少了内存的分配, 增强了数据的局部性, 提升了整体的性能.</p>
<p>总之, 要多看啊.</p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C++</a></div><div class="post-share"><div class="social-share" data-image="https://s3.bmp.ovh/imgs/2024/11/27/3e28dd3239526ce1.jpg" data-sites="facebook,twitter,wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://vdse.bdstatic.com//192d9a98d782d9c74c96f09db9378d93.mp4" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/02/17/bNFrOglBCW6ZaUq.png" alt="Wechat"/></a><div class="post-qr-code-desc">Wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/cppModern/" title="Effective Modern C++"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/04/07/52e46b1c151e1b77.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Effective Modern C++</div></div><div class="info-2"><div class="info-item-1">被人拉着去讲 Modern C++ 了, 故作此文.</div></div></div></a><a class="pagination-related" href="/misc/" title="杂七杂八的东西 - 大三上小结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.zerochan.net/Hatsune.Miku.full.1661213.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">杂七杂八的东西 - 大三上小结</div></div><div class="info-2"><div class="info-item-1">好久没更新了</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2023/01/28/SnEi2v9sdczUuyG.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">DarkSharpness</div><div class="author-info-description">逸一时，误一世!</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">33</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">24</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/DarkSharpness" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://space.bilibili.com/396961987" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://www.zhihu.com/people/darksharpness" target="_blank" title="Zhihu"><i class="iconfont icon-zhihu"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=8335592513" target="_blank" title="Cloudmusic"><i class="fa-solid fa-music"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">we will go certainly, till the end !</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%9C%AF%E8%AF%AD"><span class="toc-number">2.</span> <span class="toc-text">一些术语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-Dispatcher"><span class="toc-number">3.</span> <span class="toc-text">什么是 Dispatcher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Boxing"><span class="toc-number">3.1.</span> <span class="toc-text">Boxing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dispatch-Logic"><span class="toc-number">3.2.</span> <span class="toc-text">Dispatch Logic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E9%83%A8%E5%88%86"><span class="toc-number">4.</span> <span class="toc-text">实验部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-pybind"><span class="toc-number">4.2.</span> <span class="toc-text">年轻人的第一个 pybind</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-torch-extension"><span class="toc-number">4.3.</span> <span class="toc-text">年轻人的第一个 torch extension</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/env-shell/" title="My Windows Terminal Configuration"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2024/01/19/1d88e2436576d55c.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="My Windows Terminal Configuration"/></a><div class="content"><a class="title" href="/env-shell/" title="My Windows Terminal Configuration">My Windows Terminal Configuration</a><time datetime="2025-05-02T09:22:43.000Z" title="发表于 2025-05-02 17:22:43">2025-05-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cppModern/" title="Effective Modern C++"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2025/04/07/52e46b1c151e1b77.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Effective Modern C++"/></a><div class="content"><a class="title" href="/cppModern/" title="Effective Modern C++">Effective Modern C++</a><time datetime="2025-04-07T01:42:39.000Z" title="发表于 2025-04-07 09:42:39">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/torch/" title="dispatcher is all you need"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2024/11/27/3e28dd3239526ce1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="dispatcher is all you need"/></a><div class="content"><a class="title" href="/torch/" title="dispatcher is all you need">dispatcher is all you need</a><time datetime="2024-11-26T18:08:43.000Z" title="发表于 2024-11-27 02:08:43">2024-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/misc/" title="杂七杂八的东西 - 大三上小结"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://static.zerochan.net/Hatsune.Miku.full.1661213.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="杂七杂八的东西 - 大三上小结"/></a><div class="content"><a class="title" href="/misc/" title="杂七杂八的东西 - 大三上小结">杂七杂八的东西 - 大三上小结</a><time datetime="2024-11-04T09:10:49.000Z" title="发表于 2024-11-04 17:10:49">2024-11-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/env/" title="我讨厌配环境"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2024/07/27/3a45622b731f9c3d.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="我讨厌配环境"/></a><div class="content"><a class="title" href="/env/" title="我讨厌配环境">我讨厌配环境</a><time datetime="2024-07-25T12:51:42.000Z" title="发表于 2024-07-25 20:51:42">2024-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/cpp/" title="(Modern) C++ 小技巧汇总"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s3.bmp.ovh/imgs/2024/06/10/16be8fd59a1768c7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="(Modern) C++ 小技巧汇总"/></a><div class="content"><a class="title" href="/cpp/" title="(Modern) C++ 小技巧汇总">(Modern) C++ 小技巧汇总</a><time datetime="2024-06-09T15:01:00.000Z" title="发表于 2024-06-09 23:01:00">2024-06-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By DarkSharpness</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">DarkSharpness welcomes you!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="blur_toggle" type="button" title="切换背景模糊"><i class="fas fa-cloud"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'DarkSharpness/DarkSharpness.github.io',
      'data-repo-id': 'MDEwOlJlcG9zaXRvcnkzNDE1Nzc5NDY=',
      'data-category-id': 'DIC_kwDOFFwQ2s4CT2jG',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !true) {
    if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script src="/js/meting.min.js"></script><script src="/js/user.js"></script><div class="aplayer no-destroy" data-volume="0.1" data-id="8149615949" data-autoplay="false" data-server="netease" data-type="playlist" data-loop="all" data-order="random" data-fixed="true" mutex="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["link[rel=\"canonical\"]","meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>